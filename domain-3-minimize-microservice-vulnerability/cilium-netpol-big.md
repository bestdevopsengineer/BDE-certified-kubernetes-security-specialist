#### Create 2 Pods for Testing
```sh
kubectl run nginx --image=nginx

kubectl run curl --image=alpine=curl
```
#### Verify the connectivity
```sh
kubectl get pods -o wide

kubectl exec -it curl -- sh

curl <NGINX-IP>
```
### Example 1 - Deny Policy for Specific Pod
```sh
nano deny.yaml
```
```sh
apiVersion: "cilium.io/v2"
kind: CiliumNetworkPolicy
metadata:
  name: deny-all
spec:
  endpointSelector:
    matchLabels:
      run: nginx
  ingress:
    - {}
```
```sh
kubectl create -f deny.yaml

kubectl get ciliumnetworkpolicies
```
#### Testing 1 - Deny Policy
```sh
kubectl exec -it curl -- sh

curl <NGINX-IP>
```
### Example 2 - Allow Traffic from Curl Pod to Nginx Pod

```sh
nano allow-curl-pod.yaml
```
```sh
apiVersion: "cilium.io/v2"
kind: CiliumNetworkPolicy
metadata:
  name: allow-curl-nginx
spec:
  endpointSelector:
    matchLabels:
      run: nginx
  ingress:
    - fromEndpoints:
        - matchLabels:
            run: curl
```
```sh
kubectl create -f allow-curl-pod.yaml
```
#### Testing Policy 

```sh
kubectl exec -it curl -- sh
curl <NGINX-IP>
curl 10.0.0.129


kubectl run random-pod --image=alpine/curl -- sleep 36000
kubectl exec -it random-pod -- sh
curl <NGINX-IP>
```
kubectl delete -f allow-curl-pod.yaml

### Example 3 - Egress Policy with DNS-based Filtering

Basic Policy

```sh
apiVersion: "cilium.io/v2"
kind: CiliumNetworkPolicy
metadata:
  name: allow-egress-to-google
  namespace: default
spec:
  endpointSelector:
    matchLabels:
      run: random-pod
  egress:
  - toFQDNs:
    - matchName: "google.com"
```
Extended Policy

```sh
apiVersion: "cilium.io/v2"
kind: CiliumNetworkPolicy
metadata:
  name: allow-egress-to-google
spec:
  endpointSelector:
    matchLabels:
      run: random-pod
  egress:
  - toFQDNs:
    - matchName: "google.com"
  - toEndpoints:
    - matchLabels:
        "k8s:io.kubernetes.pod.namespace": kube-system
        "k8s:k8s-app": kube-dns
    toPorts:
    - ports:
      - port: "53"
        protocol: ANY
      rules:
        dns:
        - matchPattern: "*"
```


#### Testing Policy 

```sh
kubectl exec -it random-pod -- sh
curl <NGINX-IP>
curl -I google.com
```

### Example 4 - Egress Policy with DNS-based Filtering (Pattern Matching)

```sh
apiVersion: "cilium.io/v2"
kind: CiliumNetworkPolicy
metadata:
  name: allow-egress-to-google
spec:
  endpointSelector:
    matchLabels:
      run: random-pod
  egress:
  - toFQDNs:
    - matchPattern: "*.google.com"
  - toEndpoints:
    - matchLabels:
        "k8s:io.kubernetes.pod.namespace": kube-system
        "k8s:k8s-app": kube-dns
    toPorts:
    - ports:
      - port: "53"
        protocol: ANY
      rules:
        dns:
        - matchPattern: "*"
```


#### Testing Policy 

```sh
kubectl exec -it random-pod -- sh
curl -I google.com
curl -I accounts.google.com
```


### Example 5 - Layer 7 Example

```sh
apiVersion: "cilium.io/v2"
kind: CiliumNetworkPolicy
metadata:
  name: "rule1"
spec:
  endpointSelector:
    matchLabels:
      run: nginx
  ingress:
  - fromEndpoints:
    - matchLabels:
        run: curl
    toPorts:
    - ports:
      - port: "80"
        protocol: TCP
      rules:
        http:
        - method: "GET"
          path: "/"
```
