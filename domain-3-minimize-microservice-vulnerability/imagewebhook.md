### Documentation:

https://kubernetes.io/docs/reference/access-authn-authz/admission-controllers/

### Pre-Requisite
```sh
apt install python3-pip -y

apt install python3-venv -y

python3 -m venv myenv

source myenv/bin/activate

pip3 install flask
```
#### Configure Webhook
```sh
cd /root

nano image_policy_webhook.py
```
```sh
from flask import Flask, request, jsonify

app = Flask(__name__)

# Only allow nginx and httpd images
ALLOWED_IMAGES = {"nginx", "httpd"}

@app.route('/validate', methods=['POST'])
def validate():
    request_data = request.get_json()
    
    # Extract container images
    allowed = True
    for container in request_data.get("spec", {}).get("containers", []):
        image = container.get("image", "").split(":")[0]  # Ignore tag
        if image not in ALLOWED_IMAGES:
            allowed = False
            break

    response = {
        "apiVersion": "imagepolicy.k8s.io/v1alpha1",
        "kind": "ImageReview",
        "status": {
            "allowed": allowed
        }
    }

    return jsonify(response)

if __name__ == '__main__':
    app.run(host="0.0.0.0", port=8080, debug=True)
```
```sh
python3 image_policy_webhook.py
```


#### Configure API Server (Tab-2)
```sh
apt install net-tools
netstat -ntlp

nano /etc/kubernetes/pki/admission-config.yaml
```
```sh
apiVersion: apiserver.config.k8s.io/v1
kind: AdmissionConfiguration
plugins:
  - name: ImagePolicyWebhook
    configuration:
      imagePolicy:
        kubeConfigFile: "/etc/kubernetes/pki/webhook-kubeconfig"
        allowTTL: 50
        denyTTL: 50
        retryBackoff: 500
        defaultAllow: false
```
```sh
nano /etc/kubernetes/pki/admission-config.yaml
```

Replace the Server IP Address to your IP.

```sh
apiVersion: v1
kind: Config
clusters:
- cluster:
    server: http://64.227.144.17:8080/validate
  name: webhook
contexts:
- context:
    cluster: webhook
  name: webhook-context
current-context: webhook-context
```

#### Enable Admission Controller Plugins
```sh
nano /etc/kubernetes/manifests/kube-apiserver.yaml
```

```sh
- --admission-control-config-file=/etc/kubernetes/pki/admission-config.yaml
```

Ensure ImagePolicyWebhook Plugin is enabled
```sh
 - --enable-admission-plugins=NodeRestriction ,ImagePolicyWebhook
```

#### Test the Setup
```sh
kubectl run nginx-pod --image=nginx

kubectl run redis-pod --image=redis
```