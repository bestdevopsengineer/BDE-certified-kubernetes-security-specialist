
#### Install Kind
```sh
wget https://raw.githubusercontent.com/zealvora/certified-kubernetes-security-specialist/refs/heads/main/domain-3-minimize-microservice-vulnerability/kind-install.sh

chmod +x kind-install.sh

./kind-install.sh
```
#### Configure K8s using Kind

```sh
nano config.yaml
```
```sh
kind: Cluster
apiVersion: kind.x-k8s.io/v1alpha4
nodes:
- role: control-plane
  image: kindest/node:v1.32.2
- role: worker
  image: kindest/node:v1.32.2
- role: worker
  image: kindest/node:v1.32.2
networking:
  disableDefaultCNI: true
```
```sh
kind create cluster --config config.yaml
```
### Install Cilium
```sh
CLI_ARCH=amd64

if [ "$(uname -m)" = "aarch64" ]; then CLI_ARCH=arm64; fi
curl -L --fail --remote-name-all https://github.com/cilium/cilium-cli/releases/download/v0.16.24/cilium-linux-${CLI_ARCH}.tar.gz{,.sha256sum}

sha256sum --check cilium-linux-${CLI_ARCH}.tar.gz.sha256sum

sudo tar xzvfC cilium-linux-${CLI_ARCH}.tar.gz /usr/local/bin

rm cilium-linux-${CLI_ARCH}.tar.gz{,.sha256sum}
```

### Generate and Import PSK

```sh
kubectl create -n kube-system secret generic cilium-ipsec-keys \
    --from-literal=keys="3+ rfc4106(gcm(aes)) $(echo $(dd if=/dev/urandom count=20 bs=1 2> /dev/null | xxd -p -c 64)) 128"

kubectl -n kube-system get secrets cilium-ipsec-keys
```

### Enable Transparent Encryption in Cilium (IPSec)
```sh
cilium install --version 1.17.1 --set encryption.enabled=true --set encryption.type=ipsec

cilium status

cilium config view | grep enable-ipsec

kubectl get nodes
```
### Testing the Setup

#### Launch 2 Pods in different worker node (Terminal Tab 1)

```sh
nano curl-pod.yaml
```
```sh
apiVersion: v1
kind: Pod
metadata:
  name: curl
spec:
  nodeSelector:
    kubernetes.io/hostname: kind-worker
  containers:
  - name: busybox
    image: alpine/curl
    command: ["sleep", "36000"]
```
```sh
kubectl create -f curl-pod.yaml
```
```sh
nano nginx-pod.yaml
```

```sh
apiVersion: v1
kind: Pod
metadata:
  name: nginx
spec:
  nodeSelector:
    kubernetes.io/hostname: kind-worker2
  containers:
  - name: nginx
    image: nginx
```

```sh
kubectl create -f nginx-pod.yaml
```

#### Run a bash shell in one of the Cilium pods (Terminal Tab 2)
```sh
kubectl -n kube-system exec -ti ds/cilium -- bash
```

#### Install tcpdump and check if traffic is encrypted 
```sh
apt-get update
apt-get -y install tcpdump
```

```sh
tcpdump -n -i cilium_vxlan esp
```

#### In Terminal Tab 1
```sh
kubectl get pods -o wide

kubectl exec -it curl -- sh

curl <NGINX-POD-IP>
```
